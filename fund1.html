<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fund 1 — H² Investors</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      color-scheme: light;
      --bg-gradient: radial-gradient(circle at top, #0e1f4d 0%, #020817 50%, #010513 100%);
      --card-bg: rgba(255,255,255,0.08);
      --card-border: rgba(255,255,255,0.12);
      --accent:#33e2a0;
      --blue:#62b0ff;
      --text:#f8fbff;
      --muted:rgba(248,251,255,0.68);
    }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      font-family:'Poppins',sans-serif;
      background:var(--bg-gradient);
      color:var(--text)
    }

   header{
  padding:24px clamp(16px, 8vw, 96px);
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.logo{
  font-weight:700;
  letter-spacing:.08em;
  text-transform:uppercase;
  font-size:.95rem;
}

nav{
  display:flex;
  gap:24px;
  font-size:.95rem;
}

nav a{
  color:var(--muted);
  text-decoration:none;
}

nav a:hover{
  color:var(--text);
}


    /* ---------------------------------------------------------
       NEW GRID:  left1 | right1
                  left2 | right2
       --------------------------------------------------------- */
    main{
      flex:1;
      display:grid;
      grid-template-columns: minmax(320px,720px) 1fr;
      grid-template-areas:
        "left1 right1"
        "left2 right2";
      gap:48px;
      padding:0 8vw 10vh;
    }

    #left1{ grid-area:left1; }
   #right1{
  grid-area:right1;
  display:flex;
  flex-direction:column;
  gap:48px;
  min-height:0;
  margin-top:40px;
}

/* NEW — equal height for the two charts */
#right1 .card{
  flex:1 1 0;
  display:flex;
  flex-direction:column;
  min-height:0;
}


    #left2{ grid-area:left2; }
    #right2{
      grid-area:right2;
      margin-top:0px; /* aligns trade log with holdings */
    }

    /* CARDS --------------------------------------------------- */
    .card{
      padding:24px;
      border-radius:20px;
      border:1px solid var(--card-border);
      background:linear-gradient(160deg,rgba(14,31,77,.72),rgba(2,8,23,.86));
      backdrop-filter:blur(10px)
    }

    .chart{
      flex:1 1 auto;
      width:100%;
      min-height:0;
    }

    .chart canvas{
      width:100% !important;
      height:100% !important;
      display:block;
      margin:0;
    }

    .table-wrap{
      width:100%;
      overflow-x:auto;
      margin-top:10px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:clamp(.88rem, .9vw, .95rem);
    }

    th,td{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.12);
      text-align:left;
    }

    th{
      background:rgba(255,255,255,.06);
    }

    .badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-weight:600;
      font-size:.82rem;
    }

    .buy{
      background:rgba(51,226,160,.24);
      border:1px solid rgba(51,226,160,.6);
      color:var(--text)
    }

    .hold{
      background:rgba(255,255,255,.1);
      border:1px solid rgba(255,255,255,.25);
      color:var(--text)
    }

    footer{
      padding:36px clamp(16px, 8vw, 96px) 40px;
      color:var(--muted);
      font-size:.88rem;
      text-align:center;
      border-top:1px solid rgba(255,255,255,0.06)
    }
  </style>
</head>

<body>

<header>
  <div class="logo">H<sup>2</sup> Investors</div>
  <nav>
    <a href="#signals">Signals</a>
    <a href="#osebx">OSEBX</a>
    <a href="#about">About</a>
  </nav>
</header>

<section class="hero" style="padding:0 8vw 40px; margin-top:40px;">
  <div class="eyebrow" style="
      display:inline-flex;gap:8px;padding:6px 14px;border-radius:999px;
      background:rgba(51,226,160,.12);border:1px solid rgba(51,226,160,.32);
      color:var(--accent);font-size:.78rem;letter-spacing:.14em;
      margin-bottom:18px;text-transform:uppercase">
    Fund 1
  </div>
  <h1 style="white-space:nowrap;">Stock Picks & Portfolio Tracker</h1>
  <p style="max-width:560px;">Tina is back.</p>
</section>

<main>

  <!-- LEFT1: SIGNALS -->
  <section id="left1">
    <aside class="card" id="signals" style="margin-top:40px;">
      <h2>Today’s Signals</h2>
      <div id="meta" style="color:var(--muted);font-size:.9rem;">Loading…</div>
      <div class="table-wrap">
        <table aria-label="3-day signals">
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Last Price</th>
              <th>3-Day Return</th>
              <th>Signal</th>
              <th>As of</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="5">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </aside>
  </section>

  <!-- RIGHT1: CHARTS -->
  <section id="right1">

    <aside class="card" id="osebx">
      <h2>OSEBX (1y)</h2>
      <div id="osebx-meta" style="color:var(--muted);font-size:.9rem;">Loading…</div>
      <div class="chart"><canvas id="osebx-chart"></canvas></div>
      <div style="color:var(--muted);font-size:.8rem;margin-top:8px">Data source: Yahoo Finance</div>
    </aside>

<aside class="card" id="portfolio">
  <h2>Portfolio NAV</h2>
  <div id="portfolio-meta" style="color:var(--muted);font-size:.9rem;">
    NAV: <span id="nav-number"></span>
    · P&L: <span id="nav-pl-pct"></span>
  </div>
  <div class="chart"><canvas id="portfolio-chart"></canvas></div>
</aside>


  </section>

  <!-- LEFT2: PORTFOLIO HOLDINGS -->
  <section id="left2">
    <aside class="card">
     <h2>Portfolio Holdings
  <span style="margin-left:12px;color:var(--muted);font-size:.9rem;">
    NAV: <span id="holdings-nav-number">—</span> ·
    P&L: <span id="holdings-nav-pl">—</span>
  </span>
</h2>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Ticker</th><th>Qty</th><th>Entry</th><th>Last</th><th>P&L (NOK)</th><th>P&L (%)</th>
            </tr>
          </thead>
          <tbody id="holdings-rows">
            <tr><td colspan="6">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </aside>
  </section>

  <!-- RIGHT2: TRADE LOG -->
  <section id="right2">
    <aside class="card" id="tradelog">
      <h2>Trade Log</h2>
      <div id="tradelog-meta" style="color:var(--muted);font-size:.9rem;">Loading…</div>
      <div class="table-wrap">
        <table>
                    <thead>
            <tr>
              <th>Ticker</th>
              <th>Entry date</th>
              <th>Entry price</th>
              <th>Exit date</th>
              <th>Exit price</th>
              <th>P&L (NOK)</th>
            </tr>
          </thead>

          <tbody id="tradelog-rows">
            <tr><td colspan="6">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </aside>
  </section>

</main>

<footer id="about">
  © 2025 H<sup>2</sup> Investors · Data auto-updated by GitHub Actions
</footer>

<!-- ===========================================================
     JAVASCRIPT
     =========================================================== -->

<script>
const onProjectPage = location.hostname.endsWith('github.io') && location.pathname.includes('/Stock_fetches/');
const BASE = onProjectPage ? '' : 'https://andershagenh.github.io/Stock_fetches/';

const JSON_URL = BASE + 'public/data/scan_3day.json';
const CSV_URL  = BASE + 'public/data/scan_3day.csv';
const OSEBX_URL      = BASE + 'public/data/osebx.json';
const PORT_NAV_URL   = BASE + 'public/data/portfolio_nav.json';
const PORT_STATE_URL = BASE + 'public/data/portfolio_state.json';

const metaEl = document.getElementById('meta');
const tbody  = document.getElementById('rows');

function parseUTC(s){
  if (typeof s !== 'string') return new Date(s);
  const m = s.match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}):(\d{2})/);
  return m ? new Date(`${m[1]}T${m[2]}:${m[3]}:00Z`) : new Date(s);
}

const fmtDate = s => new Intl.DateTimeFormat('en-GB',{dateStyle:'medium',timeStyle:'short'}).format(parseUTC(s));
const fmtPct  = x => Number.isFinite(+x) ? ((+x)*100).toFixed(2) + '%' : '—';
const fmtPx   = x => Number.isFinite(+x) ? (+x).toFixed(4) : '—';
const fmtQty  = x => Number.isFinite(+x) ? (+x).toFixed(6) : '—';
const fmtNok  = x => Number.isFinite(+x) ? (+x).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2}) : '—';

window.latestScanRows = [];

function renderRows(rows){
  window.latestScanRows = Array.isArray(rows) ? rows : [];
  if (!Array.isArray(rows) || rows.length === 0) {
    metaEl.textContent = '';
    tbody.innerHTML = `<tr><td colspan="5">No data</td></tr>`;
    return;
  }
  rows.sort((a,b) => (a["3D_Return"] ?? 9e9) - (b["3D_Return"] ?? 9e9));
  metaEl.textContent = rows[0].Date ? `As of ${fmtDate(rows[0].Date)}` : '';

  tbody.innerHTML = rows.map(r=>{
    const signalRaw = (r.Signal || '').toUpperCase();
    const signalCls = signalRaw === 'BUY' ? 'buy' : 'hold';
    return `
      <tr>
        <td>${r.Ticker}</td>
        <td>${fmtPx(r.LastPrice)}</td>
        <td>${fmtPct(r["3D_Return"])}</td>
        <td><span class="badge ${signalCls}">${signalRaw}</span></td>
        <td>${fmtDate(r.Date)}</td>
      </tr>`;
  }).join('');
}

function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const headers = lines.shift().split(',').map(h => h.trim());
  return lines.map(line=>{
    const parts = line.split(',').map(v => v.trim());
    const row = {};
    headers.forEach((h,i)=>row[h] = parts[i] ?? '');
    if ('3D_Return' in row) row['3D_Return'] = Number(row['3D_Return']);
    if ('LastPrice' in row) row['LastPrice'] = Number(row['LastPrice']);
    return row;
  });
}

async function updateNavNumber(){
  try{
    const r = await fetch(`${PORT_NAV_URL}?t=${Date.now()}`, { cache:'no-store' });
    if(!r.ok) return;

    const arr = await r.json();
    if(!Array.isArray(arr) || !arr.length) return;

    const first = arr[0];
    const last = arr[arr.length - 1];

    const navValue = fmtNok(+last.nav);
    const plPctValue = fmtPct(+last.pl_pct);

    // Update Portfolio NAV card (top right)
    const navEl = document.getElementById('nav-number');
    if(navEl) navEl.textContent = navValue;

    const plEl = document.getElementById('nav-pl-pct');
    if(plEl) plEl.textContent = plPctValue;

    // Update Holdings header (bottom left)
    const hNavEl = document.getElementById('holdings-nav-number');
    if(hNavEl) hNavEl.textContent = navValue;

    const hPlEl = document.getElementById('holdings-nav-pl');
    if(hPlEl) hPlEl.textContent = plPctValue;

  }catch(e){}
}


async function loadSignals() {

  // Try JSON version first
  try {
    const r = await fetch(`${JSON_URL}?t=${Date.now()}`, { cache: 'no-store' });
    if (!r.ok) throw new Error(`JSON HTTP ${r.status}`);

    const data = await r.json();
    renderRows(data);
    loadHoldings();
    updateNavNumber();
    return;

  } catch (e) {
    // Continue to CSV fallback
  }

  // Fallback to CSV version
  try {
    const r = await fetch(`${CSV_URL}?t=${Date.now()}`, { cache: 'no-store' });
    if (!r.ok) throw new Error(`CSV HTTP ${r.status}`);

    const text = await r.text();
    renderRows(parseCSV(text));
    loadHoldings();
    updateNavNumber();

  } catch (e) {
    metaEl.textContent = 'Failed to load';
    tbody.innerHTML = `<tr><td colspan="5" style="color:#f88">Fetch error</td></tr>`;
  }
}


async function loadHoldings(){
  const tbody = document.getElementById('holdings-rows');
  try{
    const r = await fetch(`${PORT_STATE_URL}?t=${Date.now()}`, { cache:'no-store' });
    if(!r.ok){ tbody.innerHTML = `<tr><td colspan="6">No open positions</td></tr>`; return; }
    const state = await r.json();
    const positions = state.positions || {};
    const tickers = Object.keys(positions);
    if(!tickers.length){
      tbody.innerHTML = `<tr><td colspan="6">No open positions</td></tr>`;
      return;
    }

    const lastByTicker = new Map(
      (window.latestScanRows || []).map(r => [r.Ticker, Number(r.LastPrice)])
    );

    tbody.innerHTML = tickers.map(t=>{
      const p = positions[t];
      const qty = +p.qty;
      const entry = +p.entry_price;
      const last = +(lastByTicker.get(t) ?? entry);
      const stake = +(p.stake_nok ?? qty * entry);
      const plNok = qty * last - stake;
      const plPct = stake ? (plNok/stake) : 0;

      return `
        <tr>
          <td>${t}</td>
          <td>${fmtQty(qty)}</td>
          <td>${fmtPx(entry)}</td>
          <td>${fmtPx(last)}</td>
          <td>${fmtNok(plNok)}</td>
          <td>${(plPct*100).toFixed(2)}%</td>
        </tr>`;
    }).join('');
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="6">No open positions</td></tr>`;
  }
}

async function loadTradeLog() {
  const url = BASE + 'public/data/trade_log.csv?t=' + Date.now();
  const tbody = document.getElementById('tradelog-rows');
  const meta  = document.getElementById('tradelog-meta');

  try {
    const r = await fetch(url, { cache: 'no-store' });
    if (!r.ok) throw new Error('trade_log.csv not found');

    const text = await r.text();

    const lines = text.trim().split(/\r?\n/);
    const headers = lines.shift().split(',').map(h => h.trim());

    const rows = lines.map(line => {
      const cols = line.split(',').map(v => v.trim());
      return Object.fromEntries(headers.map((h,i)=>[h, cols[i] ?? '']));
    });

    if (rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6">No trades</td></tr>`;
      meta.textContent = '';
      return;
    }

    meta.textContent = `Trades: ${rows.length}`;

    tbody.innerHTML = rows.map(r => `
      <tr>
        <td>${r.Ticker}</td>
        <td>${r.EntryDate}</td>
        <td>${Number(r.EntryPrice).toFixed(4)}</td>
        <td>${r.ExitDate}</td>
        <td>${Number(r.ExitPrice).toFixed(4)}</td>
        <td>${Number(r.PL_NOK).toLocaleString('en-GB', {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })}</td>
      </tr>
    `).join('');

  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="6">Could not load trade log</td></tr>`;
    meta.textContent = '';
  }
}


loadSignals();
setInterval(loadSignals, 60_000);
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
async function drawOsebx(){
  const meta = document.getElementById('osebx-meta');
  const ctx  = document.getElementById('osebx-chart').getContext('2d');

  try{
    const res = await fetch(`${OSEBX_URL}?t=${Date.now()}`, { cache:'no-store' });
    if(!res.ok) throw new Error(`OSEBX ${res.status}`);

    const o = await res.json();
    const rows = Array.isArray(o.rows) ? o.rows : (Array.isArray(o.data) ? o.data : []);
    const labels = rows.map(p => p.t || p.date || p.time);
    const closes = rows.map(p => p.close ?? p.Close ?? p.c);

// --- Calculate P&L from fixed baseline date ---
const BASE_DATE = '2025-11-03';
let plLine = '';

const baseRow = rows.find(p => (p.t || p.date) === BASE_DATE);
const lastRow = rows[rows.length - 1];

if (baseRow && lastRow) {
  const basePrice = Number(baseRow.close ?? baseRow.Close ?? baseRow.c);
  const lastPrice = Number(lastRow.close ?? lastRow.Close ?? lastRow.c);

  if (Number.isFinite(basePrice) && Number.isFinite(lastPrice) && basePrice > 0) {
    const plPct = (lastPrice / basePrice - 1) * 100;
    const sign  = plPct >= 0 ? '+' : '';
    plLine = `P&L since ${BASE_DATE}: ${sign}${plPct.toFixed(2)}%`;
  }
}

meta.textContent = plLine || '';

// --- Draw chart ---
new Chart(ctx,{
  type:'line',
  data:{ labels, datasets:[{
    label:'OSEBX',
    data:closes,
    borderColor:'#62b0ff',
    borderWidth:2,
    pointRadius:0,
    tension:.25
  }]},
  options:{
    responsive:true,
    maintainAspectRatio:false,
    layout:{ padding:{ bottom:20 } },
    scales:{
      x:{ticks:{maxTicksLimit:6}, grid:{display:false}},
      y:{grid:{color:'rgba(255,255,255,0.12)'}}
    },
    plugins:{
      legend:{display:true},
      tooltip:{intersect:false,mode:'index'}
    }
  }
});

  }catch(e){
    meta.textContent = 'Failed to load data';
  }
}

async function drawPortfolio(){
  const meta = document.getElementById('portfolio-meta');
  const ctx  = document.getElementById('portfolio-chart').getContext('2d');

  try{
    const res = await fetch(`${PORT_NAV_URL}?t=${Date.now()}`, { cache:'no-store' });
    if(!res.ok) throw new Error(`Portfolio ${res.status}`);

    const arr = await res.json();
    const labels = arr.map(p => p.date);
    const navs   = arr.map(p => p.nav);

    meta.textContent = `NAV points: ${arr.length}`;

    new Chart(ctx,{
      type:'line',
      data:{ labels, datasets:[{
        label:'Portfolio',
        data:navs,
        borderColor:'#33e2a0',
        borderWidth:2,
        pointRadius:0,
        tension:.25
      }]},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        layout:{ padding:{ bottom:20 } },
        scales:{
          x:{ticks:{maxTicksLimit:6}, grid:{display:false}},
          y:{grid:{color:'rgba(255,255,255,0.12)'}}
        },
        plugins:{
          legend:{display:true},
          tooltip:{intersect:false,mode:'index'}
        }
      }
    });
  }catch(e){
    meta.textContent = 'No portfolio data';
  }
}

drawOsebx();
drawPortfolio();
loadTradeLog();
</script>

</body>
</html>
