<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Squarepoint Strategies</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --bg-gradient: radial-gradient(circle at top, #0e1f4d 0%, #020817 50%, #010513 100%);
      --card-bg: rgba(255, 255, 255, 0.08);
      --card-border: rgba(255, 255, 255, 0.12);
      --accent: #33e2a0;   /* portfolio green */
      --blue: #62b0ff;     /* OSEBX blue line */
      --text: #f8fbff;
      --muted: rgba(248, 251, 255, 0.68);
    }
    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;display:flex;flex-direction:column;
      font-family:'Poppins',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:var(--bg-gradient);color:var(--text)
    }
    header{padding:24px 8vw;display:flex;align-items:center;justify-content:space-between}
    .logo{font-weight:700;letter-spacing:.08em;text-transform:uppercase;font-size:.95rem}
    nav{display:flex;gap:24px;font-size:.95rem}
    nav a{color:var(--muted);text-decoration:none}
    nav a:hover{color:var(--text)}

    main{
      flex:1;
      display:grid;
      grid-template-columns:minmax(320px,720px) 1fr;
      gap:48px;
      padding:0 8vw 10vh;
    }

    .eyebrow{display:inline-flex;gap:8px;padding:6px 14px;border-radius:999px;background:rgba(51,226,160,.12);border:1px solid rgba(51,226,160,.32);color:var(--accent);font-size:.78rem;letter-spacing:.14em;margin-bottom:18px;text-transform:uppercase}
    h1{font-size:clamp(2.2rem,4vw,3.8rem);line-height:1.1;margin:0 0 18px}
    p{color:var(--muted);font-size:1.05rem;max-width:560px}
    .card{
      padding:24px;border-radius:20px;border:1px solid var(--card-border);
      background:linear-gradient(160deg,rgba(14,31,77,.72),rgba(2,8,23,.86));
      backdrop-filter:blur(10px)
    }
    .table-wrap{width:100%;overflow-x:auto;margin-top:10px}
    table{border-collapse:collapse;width:100%;font-size:.95rem}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.12);text-align:left}
    th{background:rgba(255,255,255,.06)}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:600;font-size:.82rem}
    .buy{background:rgba(51,226,160,.24);border:1px solid rgba(51,226,160,.6);color:var(--text)}
    .hold{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);color:var(--text)}
    footer{padding:36px 8vw 40px;color:var(--muted);font-size:.88rem;text-align:center;border-top:1px solid rgba(255,255,255,.06)}

    @media (max-width:1024px){ main{grid-template-columns:1fr} }
    @media (max-width:640px){ main{gap:28px;padding-bottom:64px} }

    /* Legend & holdings styles */
    .inline-legend{display:flex;gap:14px;align-items:center;margin-top:6px}
    .chip{display:inline-flex;align-items:center;gap:8px;font-size:.9rem;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot-blue{background:var(--blue)}
    .dot-green{background:var(--accent)}
    #holdings { margin-top:16px; }
    #holdings h3{ margin:6px 0 8px; font-size:1rem; }
    #holdings table th, #holdings table td { font-size:.9rem; }
  </style>
</head>
<body>
  <header>
    <div class="logo">Squarepoint</div>
    <nav>
      <a href="#signals">Signals</a>
      <a href="#osebx">OSEBX</a>
      <a href="#about">About</a>
    </nav>
  </header>

  <main>
    <!-- LEFT COLUMN -->
    <section>
      <div class="eyebrow">A Garage Project</div>
      <h1>Daily stock picks</h1>
      <p>Strategy provided by Mr. Bert.</p>

      <aside class="card" id="signals" style="margin-top:40px;">
        <h2 style="margin:0 0 8px">Today’s Signals</h2>
        <div id="meta" style="color:var(--muted);font-size:.9rem;">Loading…</div>
        <div class="table-wrap">
          <table aria-label="3-day signals">
            <thead>
              <tr>
                <th>Ticker</th>
                <th>Last Price</th>
                <th>3-Day Return</th>
                <th>Signal</th>
                <th>As of</th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr><td colspan="5">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </aside>
    </section>

    <!-- RIGHT COLUMN -->
    <aside class="card" id="osebx">
      <h2 style="margin:0 0 8px">OSEBX (1y)</h2>
      <div id="osebx-meta" style="color:var(--muted);font-size:.9rem;">Loading…</div>
      <div style="height:320px;margin-top:8px">
        <canvas id="osebx-chart"></canvas>
      </div>

      <div class="inline-legend">
        <span class="chip"><span class="dot dot-blue"></span> OSEBX</span>
        <span class="chip"><span class="dot dot-green"></span> Portfolio</span>
      </div>

      <div id="holdings" class="table-wrap" style="display:none">
        <h3>Current Holdings</h3>
        <table aria-label="Current holdings">
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Qty</th>
              <th>Entry</th>
              <th>Last</th>
              <th>P&amp;L (NOK)</th>
              <th>P&amp;L (%)</th>
            </tr>
          </thead>
          <tbody id="holdings-rows">
            <tr><td colspan="6">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <div style="color:var(--muted);font-size:.8rem;margin-top:8px">Data source: Yahoo Finance</div>
    </aside>
  </main>

  <footer id="about">
    © 2025 Squarepoint · Data auto-updated by GitHub Actions
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const onProjectPage = location.hostname.endsWith('github.io') && location.pathname.includes('/Stock_fetches/');
    const BASE = onProjectPage ? '' : 'https://andershagenh.github.io/Stock_fetches/';

    const JSON_URL = BASE + 'public/data/scan_3day.json';
    const CSV_URL  = BASE + 'public/data/scan_3day.csv';
    const OSEBX_URL = BASE + 'public/data/osebx.json';
    const PORT_NAV_URL   = BASE + 'public/data/portfolio_nav.json';
    const PORT_STATE_URL = BASE + 'public/data/portfolio_state.json';

    const metaEl = document.getElementById('meta');
    const tbody  = document.getElementById('rows');
    const fmtDate = s => new Intl.DateTimeFormat('en-GB',{dateStyle:'medium',timeStyle:'short'}).format(new Date(s));
    const fmtPct = x => Number.isFinite(+x)?((+x)*100).toFixed(2)+'%':'—';
    const fmtPx  = x => Number.isFinite(+x)?(+x).toFixed(4):'—';
    const fmtQty = x => Number.isFinite(+x)?(+x).toFixed(6):'—';

    let latestScanRows=[];

    function renderRows(rows){
      latestScanRows=Array.isArray(rows)?rows:[];
      if(!rows||!rows.length){tbody.innerHTML=`<tr><td colspan="5">No data</td></tr>`;return;}
      metaEl.textContent=rows[0].Date?`As of ${fmtDate(rows[0].Date)}`:'';
      tbody.innerHTML=rows.map(r=>{
        const s=(r.Signal||'').toUpperCase();
        return `<tr>
          <td>${r.Ticker}</td>
          <td>${fmtPx(r.LastPrice)}</td>
          <td>${fmtPct(r["3D_Return"])}</td>
          <td><span class="badge ${s==='BUY'?'buy':'hold'}">${s}</span></td>
          <td>${fmtDate(r.Date)}</td>
        </tr>`;
      }).join('');
    }

    async function loadSignals(){
      try{
        const r=await fetch(`${JSON_URL}?t=${Date.now()}`,{cache:'no-store'});
        renderRows(await r.json());
      }catch(e){console.error(e);}
    }

    async function loadOsebxAndPortfolio(){
      const meta=document.getElementById('osebx-meta');
      const ctx=document.getElementById('osebx-chart').getContext('2d');
      try{
        const [osebxRes,portRes]=await Promise.all([
          fetch(OSEBX_URL+'?t='+Date.now()),fetch(PORT_NAV_URL+'?t='+Date.now())
        ]);
        const o=await osexbRes.json(); // OSEBX data
        const p=portRes.ok?await portRes.json():[];
        const labels=o.rows.map(x=>x.t),closes=o.rows.map(x=>x.close);
        const navMap=new Map(p.map(x=>[x.date,x.nav]));
        const navSeries=labels.map(d=>navMap.get(d)||null);
        meta.textContent=`As of ${o.as_of} (source: ${o.ticker})`;
        new Chart(ctx,{type:'line',data:{labels,
          datasets:[
            {label:'OSEBX',data:closes,borderColor:getComputedStyle(document.documentElement).getPropertyValue('--blue').trim(),borderWidth:2,pointRadius:0,tension:.25},
            {label:'Portfolio',data:navSeries,borderColor:getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),borderWidth:2,pointRadius:0,tension:.25}
          ]},
          options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{maxTicksLimit:6},grid:{display:false}},y:{grid:{color:'rgba(255,255,255,0.12)'}}},plugins:{legend:{display:true,labels:{color:getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()}},tooltip:{intersect:false,mode:'index'}}}
        });
      }catch(e){meta.textContent='Failed to load data';console.error(e);}
    }

    async function loadHoldings(){
      const wrap=document.getElementById('holdings');
      const tbody=document.getElementById('holdings-rows');
      try{
        const r=await fetch(PORT_STATE_URL+'?t='+Date.now());
        const s=await r.json();
        const pos=s.positions||{};
        const last=new Map(latestScanRows.map(r=>[r.Ticker,r.LastPrice]));
        const tickers=Object.keys(pos);
        if(!tickers.length){wrap.style.display='none';return;}
        tbody.innerHTML=tickers.map(t=>{
          const p=pos[t],qty=+p.qty,entry=+p.entry_price,lastPx=+(last.get(t)||entry);
          const stake=+(p.stake_nok||qty*entry),plNok=qty*lastPx-stake,plPct=stake?(plNok/stake):0;
          return `<tr><td>${t}</td><td>${fmtQty(qty)}</td><td>${fmtPx(entry)}</td><td>${fmtPx(lastPx)}</td><td>${plNok.toFixed(2)}</td><td>${fmtPct(plPct)}</td></tr>`;
        }).join('');
        wrap.style.display='';
      }catch(e){wrap.style.display='none';}
    }

    loadSignals().then(()=>{loadOsebxAndPortfolio();loadHoldings();});
    setInterval(()=>{loadSignals();loadOsebxAndPortfolio();loadHoldings();},60000);
  </script>
</body>
</html>
