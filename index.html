<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Squarepoint Strategies</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --bg-gradient: radial-gradient(circle at top, #0e1f4d 0%, #020817 50%, #010513 100%);
      --card-bg: rgba(255, 255, 255, 0.08);
      --card-border: rgba(255, 255, 255, 0.12);
      --accent: #33e2a0;   /* portfolio green */
      --blue: #62b0ff;     /* OSEBX blue line */
      --text: #f8fbff;
      --muted: rgba(248, 251, 255, 0.68);
    }
    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;display:flex;flex-direction:column;
      font-family:'Poppins',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:var(--bg-gradient);color:var(--text)
    }
    header{padding:24px 8vw;display:flex;align-items:center;justify-content:space-between}
    .logo{font-weight:700;letter-spacing:.08em;text-transform:uppercase;font-size:.95rem}
    nav{display:flex;gap:24px;font-size:.95rem}
    nav a{color:var(--muted);text-decoration:none}
    nav a:hover{color:var(--text)}

    /* Two-column layout aligned with the header padding */
    main{
      flex:1;
      display:grid;
      grid-template-columns:minmax(320px,720px) 1fr;
      gap:48px;
      padding:0 8vw 10vh;
    }

    .eyebrow{display:inline-flex;gap:8px;padding:6px 14px;border-radius:999px;background:rgba(51,226,160,.12);border:1px solid rgba(51,226,160,.32);color:var(--accent);font-size:.78rem;letter-spacing:.14em;margin-bottom:18px;text-transform:uppercase}
    h1{font-size:clamp(2.2rem,4vw,3.8rem);line-height:1.1;margin:0 0 18px}
    p{color:var(--muted);font-size:1.05rem;max-width:560px}
    .card{
      padding:24px;border-radius:20px;border:1px solid var(--card-border);
      background:linear-gradient(160deg,rgba(14,31,77,.72),rgba(2,8,23,.86));
      backdrop-filter:blur(10px)
    }
    .table-wrap{width:100%;overflow-x:auto;margin-top:10px}
    table{border-collapse:collapse;width:100%;font-size:.95rem}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.12);text-align:left}
    th{background:rgba(255,255,255,.06)}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:600;font-size:.82rem}
    .buy{background:rgba(51,226,160,.24);border:1px solid rgba(51,226,160,.6);color:var(--text)}
    .hold{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);color:var(--text)}
    footer{padding:36px 8vw 40px;color:var(--muted);font-size:.88rem;text-align:center;border-top:1px solid rgba(255,255,255,.06)}

    /* Responsive: stack columns on smaller screens */
    @media (max-width:1024px){ main{grid-template-columns:1fr} }
    @media (max-width:640px){ main{gap:28px;padding-bottom:64px} }

    /* ---- additions for holdings table only ---- */
    #holdings { margin-top: 12px; }
    #holdings h3 { margin: 6px 0 8px; font-size: 1rem; }
    #holdings table th, #holdings table td { font-size: .9rem; }
  </style>
</head>
<body>
  <header>
    <div class="logo">Squarepoint</div>
    <nav>
      <a href="#signals">Signals</a>
      <a href="#osebx">OSEBX</a>
      <a href="#about">About</a>
    </nav>
  </header>

  <main>
    <!-- LEFT COLUMN -->
    <section>
      <div class="eyebrow">A Garage Project</div>
      <h1>Daily stock picks</h1>
      <p>Strategy provided by Mr. Bert.</p>

      <aside class="card" id="signals" style="margin-top:40px;">
        <h2 style="margin:0 0 8px">Today’s Signals</h2>
        <div id="meta" style="color:var(--muted);font-size:.9rem;">Loading…</div>
        <div class="table-wrap">
          <table aria-label="3-day signals">
            <thead>
              <tr>
                <th>Ticker</th>
                <th>Last Price</th>
                <th>3-Day Return</th>
                <th>Signal</th>
                <th>As of</th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr><td colspan="5">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </aside>
    </section>

    <!-- RIGHT COLUMN -->
    <aside class="card" id="osebx">
      <h2 style="margin:0 0 8px">OSEBX (1y)</h2>
      <div id="osebx-meta" style="color:var(--muted);font-size:.9rem;">Loading…</div>
      <div style="height:320px;margin-top:8px">
        <canvas id="osebx-chart"></canvas>
      </div>

      <!-- Holdings (hidden if no positions) -->
      <div id="holdings" class="table-wrap" style="display:none">
        <h3>Current Holdings</h3>
        <table aria-label="Current holdings">
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Qty</th>
              <th>Entry</th>
              <th>Last</th>
              <th>P&amp;L (NOK)</th>
              <th>P&amp;L (%)</th>
            </tr>
          </thead>
          <tbody id="holdings-rows">
            <tr><td colspan="6">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <div style="color:var(--muted);font-size:.8rem;margin-top:8px">Data source: Yahoo Finance</div>
    </aside>
  </main>

  <footer id="about">
    © 2025 Squarepoint · Data auto-updated by GitHub Actions
  </footer>

  <script>
    // Base path for data files (works on GitHub Pages and locally)
    const onProjectPage = location.hostname.endsWith('github.io') && location.pathname.includes('/Stock_fetches/');
    const BASE = onProjectPage ? '' : 'https://andershagenh.github.io/Stock_fetches/';

    // Signals sources
    const JSON_URL = BASE + 'public/data/scan_3day.json';
    const CSV_URL  = BASE + 'public/data/scan_3day.csv';

    // Portfolio sources (used later)
    const PORT_NAV_URL   = BASE + 'public/data/portfolio_nav.json';
    const PORT_STATE_URL = BASE + 'public/data/portfolio_state.json';

    const metaEl = document.getElementById('meta');
    const tbody  = document.getElementById('rows');

    function parseUTC(s){
      if (typeof s !== 'string') return new Date(s);
      const m = s.match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}):(\d{2})/);
      return m ? new Date(`${m[1]}T${m[2]}:${m[3]}:00Z`) : new Date(s);
    }
    const fmtDate = s => new Intl.DateTimeFormat('en-GB',{dateStyle:'medium',timeStyle:'short'}).format(parseUTC(s));
    const fmtPct  = x => Number.isFinite(+x) ? ((+x) * 100).toFixed(2) + '%' : '—';
    const fmtPx   = x => Number.isFinite(+x) ? (+x).toFixed(4) : '—';
    const fmtQty  = x => Number.isFinite(+x) ? (+x).toFixed(6) : '—';

    // expose scan rows globally so holdings code can use last prices
    window.latestScanRows = [];

    function renderRows(rows){
      window.latestScanRows = Array.isArray(rows) ? rows : [];
      if (!Array.isArray(rows) || rows.length === 0) {
        metaEl.textContent = '';
        tbody.innerHTML = `<tr><td colspan="5">No data</td></tr>`;
        return;
      }
      rows.sort((a,b) => (a["3D_Return"] ?? 9e9) - (b["3D_Return"] ?? 9e9));
      metaEl.textContent = rows[0].Date ? `As of ${fmtDate(rows[0].Date)}` : '';

      tbody.innerHTML = rows.map(r => {
        const lastPrice = fmtPx(r.LastPrice);
        const ret3d     = fmtPct(r["3D_Return"]);
        const signalRaw = (r.Signal || '').toUpperCase();
        const signalCls = signalRaw === 'BUY' ? 'buy' : 'hold';
        const asOf      = r.Date ? fmtDate(r.Date) : '—';
        return `
          <tr>
            <td>${r.Ticker}</td>
            <td>${lastPrice}</td>
            <td>${ret3d}</td>
            <td><span class="badge ${signalCls}">${signalRaw}</span></td>
            <td>${asOf}</td>
          </tr>`;
      }).join('');
    }

    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const headers = lines.shift().split(',').map(h => h.trim());
      return lines.map(line => {
        const parts = line.split(',').map(v => v.trim());
        const row = {};
        headers.forEach((h,i) => row[h] = parts[i] ?? '');
        if ('3D_Return' in row) row['3D_Return'] = Number(row['3D_Return']);
        if ('LastPrice' in row) row['LastPrice'] = Number(row['LastPrice']);
        return row;
      });
    }

    async function loadSignals(){
      try{
        const r = await fetch(`${JSON_URL}?t=${Date.now()}`, { cache:'no-store' });
        if (!r.ok) throw new Error(`JSON HTTP ${r.status}`);
        renderRows(await r.json());
        return;
      }catch(e){
        console.warn('JSON failed, falling back to CSV:', e);
      }
      try{
        const r = await fetch(`${CSV_URL}?t=${Date.now()}`, { cache:'no-store' });
        if (!r.ok) throw new Error(`CSV HTTP ${r.status}`);
        const text = await r.text();
        renderRows(parseCSV(text));
      }catch(e){
        console.error(e);
        metaEl.textContent = 'Failed to load';
        tbody.innerHTML = `<tr><td colspan="5" style="color:#f88">Fetch error: ${String(e)}</td></tr>`;
      }
    }

    loadSignals();
    setInterval(loadSignals, 60_000);
  </script>

  <!-- Chart.js for the OSEBX + (optional) Portfolio lines -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
  (()=>{
    // Recompute BASE locally so this block is self-contained
    const onProjectPage = location.hostname.endsWith('github.io') && location.pathname.includes('/Stock_fetches/');
    const BASE = onProjectPage ? '' : 'https://andershagenh.github.io/Stock_fetches/';
    const OSEBX_URL      = BASE + 'public/data/osebx.json';
    const PORT_NAV_URL   = BASE + 'public/data/portfolio_nav.json';
    const PORT_STATE_URL = BASE + 'public/data/portfolio_state.json';

    const fmtPct = x => Number.isFinite(+x) ? ((+x) * 100).toFixed(2) + '%' : '—';
    const fmtPx  = x => Number.isFinite(+x) ? (+x).toFixed(4) : '—';
    const fmtQty = x => Number.isFinite(+x) ? (+x).toFixed(6) : '—';

    async function drawChart() {
      const meta = document.getElementById('osebx-meta');
      const ctx  = document.getElementById('osebx-chart').getContext('2d');

      let chart = null;

      // 1) Always render OSEBX first
      try {
        const res = await fetch(`${OSEBX_URL}?t=${Date.now()}`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`OSEBX ${res.status}`);
        const o = await res.json();

        const rows = Array.isArray(o.rows) ? o.rows : Array.isArray(o.data) ? o.data : [];
        const labels = rows.map(p => p.t || p.date || p.time);
        const closes = rows.map(p => p.close ?? p.Close ?? p.c);

        if (!labels.length || !closes.length) throw new Error('OSEBX: empty data');

        meta.textContent = `As of ${o.as_of || o.asOf || ''} (source: ${o.ticker || 'OSEBX.OL'})`;

        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'OSEBX',
              data: closes,
              tension: 0.25,
              borderWidth: 2,
              borderColor: '#62b0ff',
              pointRadius: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { ticks: { maxTicksLimit: 6 }, grid: { display: false } },
              y: { grid: { color: 'rgba(255,255,255,0.12)' } }
            },
            plugins: {
              legend: { display: true },
              tooltip: { intersect: false, mode: 'index' }
            }
          }
        });
      } catch (err) {
        console.error(err);
        document.getElementById('osebx-meta').textContent = 'Failed to load data';
        return;
      }

      // 2) Overlay Portfolio if available (non-blocking)
      try {
        const r = await fetch(`${PORT_NAV_URL}?t=${Date.now()}`, { cache: 'no-store' });
        if (!r.ok) throw new Error(`Portfolio ${r.status}`);
        const navArr = await r.json();
        if (!Array.isArray(navArr) || navArr.length === 0) throw new Error('Portfolio: empty');

        const navMap = new Map(navArr.map(p => [p.date, p.nav]));
        const navSeries = chart.data.labels.map(d => navMap.get(d) ?? null);

        chart.data.datasets.push({
          label: 'Portfolio',
          data: navSeries,
          tension: 0.25,
          borderWidth: 2,
          borderColor: '#33e2a0',
          pointRadius: 0
        });
        chart.update();
      } catch (err) {
        console.warn('Portfolio overlay skipped:', err.message || err);
      }

      // 3) Holdings table (independent; hidden if none)
      loadHoldings();
    }

    async function loadHoldings() {
      const wrap  = document.getElementById('holdings');
      const tbody = document.getElementById('holdings-rows');
      try {
        const r = await fetch(`${PORT_STATE_URL}?t=${Date.now()}`, { cache: 'no-store' });
        if (!r.ok) { wrap.style.display = 'none'; return; }
        const state = await r.json();
        const positions = state.positions || {};
        const tickers = Object.keys(positions);
        if (!tickers.length) { wrap.style.display = 'none'; return; }

        const lastByTicker = new Map((window.latestScanRows || []).map(r => [r.Ticker, Number(r.LastPrice)]));

        const rowsHtml = tickers.map(t => {
          const p = positions[t];
          const qty   = Number(p.qty);
          const entry = Number(p.entry_price);
          const last  = Number(lastByTicker.get(t) ?? entry);
          const stake = Number(p.stake_nok ?? qty * entry);
          const plNok = qty * last - stake;
          const plPct = stake ? (plNok / stake) : 0;
          return `<tr>
            <td>${t}</td>
            <td>${fmtQty(qty)}</td>
            <td>${fmtPx(entry)}</td>
            <td>${fmtPx(last)}</td>
            <td>${plNok.toFixed(2)}</td>
            <td>${(plPct*100).toFixed(2)}%</td>
          </tr>`;
        }).join('');

        tbody.innerHTML = rowsHtml;
        wrap.style.display = '';
      } catch {
        wrap.style.display = 'none';
      }
    }

    drawChart();
    setInterval(drawChart, 60_000);
  })();
  </script>
</body>
</html>
