name: Update 3-day scan

on:
  schedule:
    - cron: "*/15 * * * *"   # trigger every 15 minutes (UTC)
  workflow_dispatch:

concurrency:
  group: scan-3day
  cancel-in-progress: true

jobs:
  run-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      # --- Time filter: only run at 08:00, 08:15, 08:30, 08:45 ... Oslo time, Mon–Fri, within 08–18 ---
      - name: Skip if not on 15-min marks or outside 08–18 Europe/Oslo (Mon–Fri)
        run: |
          dow=$(TZ=Europe/Oslo date +%u)   # 1=Mon ... 7=Sun
          hour=$(TZ=Europe/Oslo date +%H)
          min=$(TZ=Europe/Oslo date +%M)

          # Only Mon–Fri
          if [ "$dow" -gt 5 ]; then
            echo "Weekend in Europe/Oslo; skipping."
            exit 0
          fi

          # Only 08:00–17:59 (i.e., before 18:00)
          if [ "$hour" -lt 8 ] || [ "$hour" -ge 18 ]; then
            echo "Outside 08–18 Europe/Oslo; skipping."
            exit 0
          fi

          # Only at 00, 15, 30, 45
          case "$min" in
            00|15|30|45) echo "On 15-min mark ($hour:$min Oslo), continuing." ;;
            *) echo "Not on a 15-min mark ($hour:$min Oslo); skipping."; exit 0 ;;
          esac

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install yfinance pandas numpy requests

      - name: Run scanner
        run: python stockfetches.py

      # --- NEW: notify Discord only if trade log changed ---
      - name: Check if trade log changed
        id: tradelog
        run: |
          TRADE_LOG="public/data/trade_log.csv"

          if [ ! -f "$TRADE_LOG" ]; then
            echo "Trade log not found at $TRADE_LOG; skipping Discord notify."
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if git diff --quiet -- "$TRADE_LOG"; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Notify Discord (new trade)
        if: steps.tradelog.outputs.changed == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_FUND1 }}
        run: |
          TRADE_LOG_URL="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${GITHUB_REF_NAME}/public/data/trade_log.csv"
          curl -H "Content-Type: application/json" \
               -d "{\"content\":\"New trade logged. Updated trade log: ${TRADE_LOG_URL}\"}" \
               "$DISCORD_WEBHOOK_URL"

      - name: Commit and push results
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add public/data/scan_3day.json public/data/scan_3day.csv public/data/trade_log.csv || true
          git commit -m "update scan data" || echo "no changes"
          git push
